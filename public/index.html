<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>upwork-jobs-report</title>
  <style>
    body{font-family:Inter,Arial,sans-serif;background:#0b0f14;color:#e6edf3;margin:0;padding:24px}
    h1{margin:0 0 8px}
    .muted{color:#9fb0c3;font-size:14px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:14px;margin-top:18px}
    .card{background:#121922;border:1px solid #223041;border-radius:12px;padding:14px}
    a{color:#6cb6ff;text-decoration:none}
    .meta{display:flex;justify-content:space-between;gap:8px;font-size:13px;color:#9fb0c3;margin:8px 0}
    .budget{color:#7ee787;font-weight:600}
    .actions{display:flex;gap:8px;margin-top:10px}
    .btn{display:inline-block;padding:8px 10px;border-radius:8px;border:1px solid #2b3a4d;color:#e6edf3;background:#182230;font-size:13px}
    .btn:hover{background:#223041}
    .toplinks{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
    .section{margin-top:22px}
    .section h2{font-size:18px;margin-bottom:10px;color:#c9d7e6}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;align-items:center}
    .tab{cursor:pointer}
    .tab.active{border-color:#4ea1ff;background:#223041}
    select.sort{background:#182230;color:#e6edf3;border:1px solid #2b3a4d;border-radius:8px;padding:8px 10px}
  </style>
</head>
<body>
  <h1>Upwork Jobs Report</h1>
  <div class="muted" id="status">Loading…</div>
  <div class="muted" id="source-indicator" style="margin-top:6px"></div>
  <div class="toplinks">
    <a class="btn" href="/jobs.csv" target="_blank" rel="noreferrer">Download CSV Backup</a>
    <a class="btn" href="/upwork-jobs-report.json" target="_blank" rel="noreferrer">View JSON Feed</a>
    <a class="btn" href="/pdfs/" target="_blank" rel="noreferrer">Open PDFs Folder</a>
    <button class="btn" id="refresh-btn" type="button">Refresh Jobs</button>
  </div>

  <div class="toolbar">
    <button class="btn tab active" id="tab-all" type="button">All Jobs (<span id="all-count">0</span>)</button>
    <button class="btn tab" id="tab-ai" type="button">AI / OpenClaw (<span id="ai-count">0</span>)</button>
    <button class="btn tab" id="tab-amazon" type="button">Amazon (<span id="amazon-count">0</span>)</button>

    <label class="muted" for="sort-order">Sort:</label>
    <select id="sort-order" class="sort">
      <option value="newest" selected>Most recent first</option>
      <option value="oldest">Oldest first</option>
      <option value="budget_high">Budget high to low</option>
      <option value="budget_low">Budget low to high</option>
    </select>
  </div>

  <div class="muted" id="refresh-meta" style="margin-top:8px"></div>

  <div class="section">
    <h2 id="section-title">All Jobs</h2>
    <div class="grid" id="jobs-main"></div>
  </div>

  <script>
    const FILES = [
      '/jobs.json',
      '/upwork-jobs-report.json',
      '/upwork jobsreport.json'
    ];

    // Optional Supabase source (set these in a small inline script before this block)
    // window.UPWORK_SUPABASE_URL = 'https://<project>.supabase.co'
    // window.UPWORK_SUPABASE_ANON_KEY = '<anon-key>'
    const SUPABASE_URL = window.UPWORK_SUPABASE_URL || 'https://vcjhompqxlklhibuyosn.supabase.co';
    const SUPABASE_ANON_KEY = window.UPWORK_SUPABASE_ANON_KEY || 'sb_publishable_RAt-BI9SnN0s5DOX4Crkwg_QacwnAm8';

    async function loadData(){
      const bust = `t=${Date.now()}`;
      let supabaseIssue = '';

      // Preferred source: Supabase table
      if (SUPABASE_URL && SUPABASE_ANON_KEY) {
        try {
          const supabaseEndpoint = `${SUPABASE_URL}/rest/v1/upwork_jobs?select=title,budget,tags,url,folder,date,description,pdf_url&order=date.desc&limit=300`;
          const res = await fetch(`${supabaseEndpoint}&${bust}`, {
            cache:'no-store',
            headers: {
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            }
          });

          if (res.ok) {
            const data = await res.json();
            if (Array.isArray(data) && data.length) {
              return {file:'supabase:upwork_jobs', data};
            }
            supabaseIssue = 'supabase empty';
          } else {
            supabaseIssue = `supabase ${res.status}`;
          }
        } catch (e) {
          supabaseIssue = `supabase error`;
        }
      }

      // Fallback source: static JSON files
      for(const f of FILES){
        try{
          const url = `${f}${f.includes('?') ? '&' : '?'}${bust}`;
          const res = await fetch(url, {cache:'no-store'});
          if(res.ok){
            const data = await res.json();
            const source = supabaseIssue ? `${f} (fallback: ${supabaseIssue})` : f;
            return {file:source,data};
          }
        }catch(e){}
      }
      throw new Error('No data file found');
    }

    async function loadRefreshMeta(){
      const meta = document.getElementById('refresh-meta');
      try{
        const res = await fetch(`/dashboard-refresh.json?t=${Date.now()}`, {cache:'no-store'});
        if(!res.ok) throw new Error('meta missing');
        const data = await res.json();
        if(data?.refreshedAt){
          meta.textContent = `Last dashboard data refresh: ${fmtDate(data.refreshedAt)}`;
          return;
        }
      }catch(e){}
      meta.textContent = '';
    }

    function fmtDate(iso){
      if(!iso) return 'Unknown date';
      const d = new Date(iso);
      if(Number.isNaN(d.getTime())) return iso;
      return d.toLocaleString('en-GB', {timeZone:'UTC'}) + ' UTC';
    }

    const AMAZON_KEYWORDS_STRONG = [
      'seller central','vendor central','amazon ppc','amazon fba','amazon fbm','amazon account manager',
      'listing optimization','a+ content','brand registry','buy box','flat file'
    ];
    const AMAZON_KEYWORDS_MEDIUM = [
      'amazon','fba','fbm','listing','catalog','storefront','ppc','asin','variation listing'
    ];

    const AI_KEYWORDS_STRONG = [
      'openclaw','claude code','llm','langchain','langgraph','multi-agent','ai agent','agentic'
    ];
    const AI_KEYWORDS_MEDIUM = [
      'ai','artificial intelligence','automation','agent','chatbot','gpt','claude','n8n','make.com'
    ];

    function scoreByKeywords(text, strong, medium){
      let score = 0;
      for (const k of strong) if (text.includes(k)) score += 3;
      for (const k of medium) if (text.includes(k)) score += 1;
      return score;
    }

    function classifyJob(job){
      const text = `${job.title || ''} ${(job.description || '')} ${(job.tags || []).join(' ')}`.toLowerCase();
      const amazonScore = scoreByKeywords(text, AMAZON_KEYWORDS_STRONG, AMAZON_KEYWORDS_MEDIUM);
      const aiScore = scoreByKeywords(text, AI_KEYWORDS_STRONG, AI_KEYWORDS_MEDIUM);

      if (amazonScore >= aiScore && amazonScore >= 2) return 'amazon';
      if (aiScore > amazonScore && aiScore >= 2) return 'ai';

      // fallback to AI section since pipeline is AI-focused
      return 'ai';
    }

    let allJobs = [];
    let currentView = 'all';

    function parseBudget(budgetStr){
      if (!budgetStr) return 0;
      const n = String(budgetStr).replace(/,/g,'').match(/[\d.]+/);
      return n ? Number(n[0]) : 0;
    }

    function sortJobs(items){
      const mode = document.getElementById('sort-order').value;
      const arr = [...items];
      if (mode === 'oldest') {
        arr.sort((a,b) => new Date(a.date || 0) - new Date(b.date || 0));
      } else if (mode === 'budget_high') {
        arr.sort((a,b) => parseBudget(b.budget) - parseBudget(a.budget));
      } else if (mode === 'budget_low') {
        arr.sort((a,b) => parseBudget(a.budget) - parseBudget(b.budget));
      } else {
        arr.sort((a,b) => new Date(b.date || 0) - new Date(a.date || 0));
      }
      return arr;
    }

    function renderCards(items){
      if (!items.length) return '<div class="muted">No jobs in this section yet.</div>';
      return items.map(j => `
        <div class="card">
          <a href="${j.url || '#'}" target="_blank" rel="noreferrer"><strong>${j.title || 'Untitled'}</strong></a>
          <div class="meta"><span>${fmtDate(j.date)}</span><span class="budget">${j.budget || 'N/A'}</span></div>
          <div class="muted">${(j.description || '').slice(0,180)}</div>
          <div class="actions">
            <a class="btn" href="${j.url || '#'}" target="_blank" rel="noreferrer">View Job</a>
            ${j.pdf_url ? `<a class="btn" href="${j.pdf_url}" target="_blank" rel="noreferrer">Download PDF</a>` : ''}
          </div>
        </div>
      `).join('');
    }

    function setActiveTab(view){
      currentView = view;
      const tabs = ['all','ai','amazon'];
      for (const t of tabs) {
        document.getElementById(`tab-${t}`).classList.toggle('active', t === view);
      }
      renderCurrentView();
    }

    function renderCurrentView(){
      const mainGrid = document.getElementById('jobs-main');
      const title = document.getElementById('section-title');
      const amazonJobs = allJobs.filter(j => classifyJob(j) === 'amazon');
      const aiJobs = allJobs.filter(j => classifyJob(j) === 'ai');

      document.getElementById('all-count').textContent = allJobs.length;
      document.getElementById('ai-count').textContent = aiJobs.length;
      document.getElementById('amazon-count').textContent = amazonJobs.length;

      let viewJobs = allJobs;
      if (currentView === 'ai') {
        title.textContent = 'AI / OpenClaw Jobs';
        viewJobs = aiJobs;
      } else if (currentView === 'amazon') {
        title.textContent = 'Amazon Jobs';
        viewJobs = amazonJobs;
      } else {
        title.textContent = 'All Jobs';
      }

      mainGrid.innerHTML = renderCards(sortJobs(viewJobs));
    }

    function render(items,file){
      const status = document.getElementById('status');
      const sourceIndicator = document.getElementById('source-indicator');
      const latest = items[0]?.date ? fmtDate(items[0].date) : 'n/a';
      const sourceLabel = file.startsWith('supabase:') ? 'Supabase (live)' : `Static file (${file})`;

      allJobs = [...items];
      status.textContent = `${items.length} jobs loaded. Latest: ${latest}`;
      sourceIndicator.textContent = `Data source: ${sourceLabel}`;
      renderCurrentView();
    }

    async function reloadJobs(){
      const status = document.getElementById('status');
      status.textContent = 'Refreshing…';
      try{
        const {file,data} = await loadData();
        render(data,file);
        await loadRefreshMeta();
      }catch(err){
        status.textContent = 'Failed to load jobs data: ' + err.message;
      }
    }

    document.getElementById('refresh-btn').addEventListener('click', reloadJobs);
    document.getElementById('sort-order').addEventListener('change', renderCurrentView);
    document.getElementById('tab-all').addEventListener('click', () => setActiveTab('all'));
    document.getElementById('tab-ai').addEventListener('click', () => setActiveTab('ai'));
    document.getElementById('tab-amazon').addEventListener('click', () => setActiveTab('amazon'));

    reloadJobs();
  </script>
</body>
</html>
